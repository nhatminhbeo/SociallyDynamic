// ===========================================================================
// File: /logic/student.js
// Description: Export API functions that handle requests at /api/student/*
// Author: Minh Tran Quoc, Ruohan Hu
// Last updated: Mar 14 2017
// ===========================================================================

// ===============================================================================================================================================
//    Path                    |   Method    |   Purpose / Brief Description
// ===============================================================================================================================================
//                                   Student (USA + UPV + MS + MUP)
// ===============================================================================================================================================
//    /api/student/           |   POST      |   Create a student with criteria(JSON) in request body
//    /api/student/:id        |   PUT       |   Modify a student defined by id with new criteria(JSON) in request body
//    /api/student/:id        |   DELETE    |   Delete a student defined by id
//    /api/student/:id        |   GET       |   Get profile of a student as JSON object
//    /api/student/friend/:id |   GET       |   Get a list of friends (name, profile pic, id) of user defined by id
// ===============================================================================================================================================

var models = require('./general');

// ================================================================================
//  Function: postStudent
//  REST: POST:/api/student/
//  Description:
//  Expected input (req.body):
//  		- _id : id String auto generated by firebase 
//          - Email : String
//          - FirstName : String
//			- LastName : String
//			- Age : int
//			- Bio : String
//			- Email : String
//			- Major : String
//			- Class : [String]
// 			- Habit : [String]
//  Expected output (res):
//          - respond code: 200 for created (success), user added to database
//							400 for failed
//  Author: Minh Tran Quoc
// ================================================================================
module.exports.postStudent = function (req, res) {

	var ref = req.body;

	// Put necessary fields into a student model.
	var newStudent = models.Student({
		_id: ref._id,
		Email: ref.Email,
		FirstName: ref.FirstName,
		LastName: ref.LastName,
		Age: ref.Age,
		Bio: ref.Bio,
		Major: ref.Major
	});


	// Create it in database
	newStudent.save(function(err) {

		// For each class
		return models.Promise.each(ref.Class, function (Class) {

			// Save the classStudent relationship
			var classStudent = models.ClassStudent({
				StudentID: ref._id,
				Class: Class
			});
			return classStudent.save();
		});


	}).then(function () {

		// For each habit
		return models.Promise.each(ref.Habit, function(Habit) {
		
			// Save the student class relationship
			var studentStudyHabit = models.StudentStudyHabit({
				StudentID: ref._id,
				Habit: Habit
			});
			return studentStudyHabit.save();
		});

	// Return 200 if success
	}).then(function() {
		res.status(200).send();

	// Return 400 if fail anywhere
	}).then(null, function() {
		res.status(400).send();
	});

};


// ================================================================================
//  Function: putStudentWithId
//  REST: PUT:/api/student/:id
//  Description: Change the information of an existing user
//  Expected input
//			(req.params.id): the id of user being changed
//			(req.body): new information in JSON format, including: 
//        		- Email : String
//        		- FirstName : String
//				- LastName : String
//				- Age : int
//				- Bio : String
//				- Email : String
//				- Major : String
//				- Class : String array
// 				- Habit : String array
//  Expected output (res):
//          - respond code: 200 for created (success), user modified in database
//							400 for failed
//  Author: Minh Tran Quoc
// ================================================================================
module.exports.putStudentWithId = function (req, res) {

	var ref = req.body;
	var entries = {
		Email: ref.Email,
		FirstName: ref.FirstName,
		LastName: ref.LastName,
		Age: ref.Age,
		Bio: ref.Bio,
		Major: ref.Major
	}

	// Update the student
	models.Student.update({"_id": req.params.id}, entries).exec()

	// Remove all ClassStudent
	.then(function () {
		return models.ClassStudent.remove({StudentID: req.params.id});
	})

	// Update new ClassStudent
	.then(function () {
		return models.Promise.each(ref.Class, function (Class) {
			// Save the classStudent relationship
			return models.ClassStudent({
				StudentID: req.params.id,
				Class: Class
			}).save();
		});

	// Remove all StudentStudyHabit
	}).then(function () {
		return models.StudentStudyHabit.remove({StudentID: req.params.id});

	// Update new StudentStudyHabit	
	}).then(function () {
		return models.Promise.each(ref.Habit, function (Habit) {
			// Save the StudentStudyHabit relationship
			return StudentStudyHabit({
				StudentID: req.params.id,
				Habit: Habit
			}).save();
		});
	
	// Return 200 if success
	}).then(function () {
		res.status(200).send();
	
	// Return 400 if failed
	}).then(null, function() {
		res.status(400).send();
	});
};


// ================================================================================
//  Function: deleteStudentWithId
//  REST: DELETE:/api/student/:id
//  Description: delete profile of an user
//  Expected input (req.params.id): id of the user being deleted
//  Expected output (res):
//          - respond code: 200 for created (success), user data emptied, but not deleted
//							400 for failed
//  Author: Minh Tran Quoc
// ================================================================================
module.exports.deleteStudentWithId = function (req, res) {

	var id = req.params.id;

	// Deleting all friendship request of student
	models.FriendRequest.remove({'$or': [{Sender: id}, {Receiver: id}]}).exec()

	// Deleting all friendships of student
	.then(function() {
		return models.Friendship.remove({UserID: id}).exec();
	})

	// Deleting all study habits of student
	.then(function() {
		return models.StudentStudyHabit.remove({StudentID: id}).exec();
	})

	// Deleting all classes of student
	.then(function() {
		return models.ClassStudent.remove({StudentID: id}).exec();
	})

/* FUTURE FUNCTIONALITIES
	// Removing student from all groups
	.then(function() {
		return models.StudentGroup.remove({StudentID: id}).exec();
	})

	// Removing all group request of the user
	.then(function() {
		return models.GroupRequest.remove({'$or': [{Sender: id}, {Receiver: id}]}).exec();
	})

	// Removing all group the user owns
	.then(function() {
		return models.Group.find({Owner: id}, '_id').exec();
	}).then(function(group) {
		return models.StudentGroup.remove({GroupID: group._id}), function (err){
			if (!err) {
				return GroupMessage.remove({GroupID: group._id}, function (err) {
					if (!err) return Group.remove({_id: group._id}).exec();
				});
			}
		});
	})

	// Remove all conversations of the user
	.then(function() {
		return models.Conversation.find({StudentID: id}, '_id').exec();
	}).then(function (conversation) {
		return models.Message.remove({ConversatoinID: conversatoin._id});
	}).then(function () {
		return models.Conversation.remove({StudentID: id}).exec();
	})
*/

	// Removing the actual the user
	.then(function () {
		return models.Student.remove({_id: id}).exec();
	})

	// Student removed successfully
	.then(function () {
		return res.status(200).send();
	})

	// Failed to remove student
	.then(null, function() {
		res.status(400).send();
	});
};


// ================================================================================
//  Function: getStudentWithId
//  REST: GET:/api/student/:id
//  Description:
//  Expected input (req.body):
//  Expected output (res):
//  Author: Ruohan Hu
// ================================================================================
module.exports.getStudentWithId = function (req, res) {
	var studentID = req.params.id;
	
	// get a user with the ID
	models.Student.findById(studentID, function(err, user) {
		if (err) res.status(400).send(err);
		
		// show the user
		var jsonStudent = {
			_id: user._id,
			FirstName: user.FirstName,
			LastName: user.LastName,
			Age: user.Age,
			Bio: user.Bio,
			Email: user.Email,
			Major: user.Major,
			Class: [],
			Habit: []
		};

		// Find all class and append to jsonStudent.Class
		models.ClassStudent.find({"StudentID": studentID}).exec()

		.then(function (found) {
			return models.Promise.each(found, function (entry) {
					jsonStudent.Class.push(String(entry.Class));
			});
		})

		// Find all habits and append to jsonStudent.Habit
		.then(function() {
			return models.StudentStudyHabit.find({"StudentID": studentID});	
		})

		.then(function (found) {
			return models.Promise.each(found, function (entry) {
				jsonStudent.Habit.push(String(entry.Habit));
			});
		})

		// Success
		.then(function () {

			res.status(200).json(jsonStudent);
		})

		// Fail
		.then(null, function () {
			res.status(400).send();
		});
	});
};


// ================================================================================
//  Function: getStudentFriendWithId
//  REST: GET:/api/student/friend/:id
//  Description:
//  Expected input (req.body):
//  Expected output (res):
//  Author: Ruohan Hu
// ================================================================================
module.exports.getStudentFriendWithId = function (req, res) {
	var list = [];

	models.Friendship.find({"UserID": req.params.id}).exec()
	.then(function(classes) {

		// For each such class:
		return models.Promise.each(classes, function(thisClass) {
			var FriendID = "";
			if (thisClass.UserID[0] != req.params.id) {
				FriendID = thisClass.UserID[0];
			} else {
				FriendID = thisClass.UserID[1];
			}

			return models.Student.findOne({"_id": FriendID}) 
			.then(function(user) {

				var jsonStudent = {
					_id: user._id,
					FirstName: user.FirstName,
					LastName: user.LastName,
					Age: user.Age,
					Bio: user.Bio,
					Email: user.Email,
					Major: user.Major
				}
				list.push(jsonStudent);
			});
		});
	})

	// succeed
	.then(function() {
		return res.status(200).json(list);
	})

	// Failed
	.then(null, function() {
		res.status(400).send();
	});

	
};